{% load i18n %}
<div class="modal" :class="{ 'modal-open': showBulkMilestoneModal }" @keydown.escape="showBulkMilestoneModal = false" role="dialog" aria-modal="true" aria-labelledby="bulk-milestone-modal-title">
  <div class="modal-box">
    <h3 id="bulk-milestone-modal-title" class="font-bold text-lg mb-4">{% translate "Move to Milestone" %}</h3>
    <input type="hidden" name="milestone" id="bulk-milestone-hidden" :value="selectedMilestoneValue">

    {# Step 1: Selection #}
    <div x-show="!milestoneConfirmStep" x-cloak>
      <p class="mb-4">{% translate "Select a milestone to move the selected epics to:" %}</p>
      <div class="max-h-60 overflow-y-auto border border-base-300 rounded-lg">
        <ul class="menu p-2">
          <li>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="radio" name="bulk-milestone-select" id="bulk-milestone-none" class="radio radio-primary" checked
                     @change="selectedMilestoneName = '{% translate "No milestone" %}'; selectedMilestoneValue = ''">
              <span class="text-base-content/70 italic">{% translate "No milestone (remove from current)" %}</span>
            </label>
          </li>
          {% for milestone in project_milestones %}
          <li>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="radio" name="bulk-milestone-select" class="radio radio-primary" value="{{ milestone.pk }}"
                     @change="selectedMilestoneName = '{{ milestone.title|escapejs }}'; selectedMilestoneValue = '{{ milestone.pk }}'">
              <span>[{{ milestone.key }}] {{ milestone.title }}</span>
            </label>
          </li>
          {% endfor %}
        </ul>
      </div>
      <div class="modal-action">
        <button class="btn btn-ghost" @click="showBulkMilestoneModal = false">{% translate "Cancel" %}</button>
        <button class="btn btn-primary" @click="milestoneConfirmStep = true">{% translate "Continue" %}</button>
      </div>
    </div>

    {# Step 2: Confirmation #}
    <div x-show="milestoneConfirmStep" x-cloak>
      <p class="mb-4">
        {% translate "Move selected epics to:" %}
        <strong x-text="selectedMilestoneName"></strong>
      </p>
      <p class="text-sm text-base-content/70 mb-4" x-text="selectedCount + ' {% translate "epic(s) will be updated" %}'"></p>
      <div class="modal-action">
        <button class="btn btn-ghost" @click="milestoneConfirmStep = false">{% translate "Back" %}</button>
        <button class="btn btn-primary"
                hx-post="{% url 'workspace_issues_bulk_milestone' workspace.slug %}"
                hx-vals='{"search": "{{ search_query|default:"" }}", "status_filter": "{{ status_filter|default:"" }}", "priority_filter": "{{ priority_filter|default:"" }}", "assignee_filter": "{{ assignee_filter|default:"" }}", "project_filter": "{{ project.key }}", "embed": "project_epics"}'
                hx-include="#epics-embed [name='epics']:checked, #bulk-milestone-hidden"
                hx-target="#epics-embed"
                hx-swap="innerHTML"
                hx-indicator="#epics-list-loading"
                hx-disabled-elt="this"
                @click="showBulkMilestoneModal = false; milestoneConfirmStep = false">
          {% translate "Confirm Move" %}
        </button>
      </div>
    </div>
  </div>
  <div class="modal-backdrop" @click="showBulkMilestoneModal = false; milestoneConfirmStep = false"></div>
</div>
