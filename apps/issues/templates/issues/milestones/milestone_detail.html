{% extends "apps/base.html" %}
{% load i18n attachments_tags attachment_extras %}
{% block app_content_content %}
<div id="page-content" hx-target="#page-content">
  {% partialdef page-content inline %}
  <section class="app-card" x-data="{ showDeleteModal: false, showCascadeModal: false }">
    {% include "issues/includes/milestone_detail_header.html" %}

    {# Issues, History, and Attachments Tabs #}
    {% get_attachments_for milestone as milestone_attachments %}
    {% with image_atts=milestone_attachments|filter_images %}
    {% if image_atts %}
    <div class="flex gap-2 mt-4 flex-wrap">
      {% for att in image_atts|slice:":5" %}
      <a href="{{ att.attachment_file.url }}" target="_blank"
         class="block w-40 h-40 overflow-hidden rounded border border-base-300 hover:opacity-80 transition-opacity">
        <img src="{{ att.attachment_file.url }}" alt="{{ att.filename }}" class="w-full h-full object-cover">
      </a>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
    <div class="mt-6" x-data="{ activeTab: 'issues' }">
      <div role="tablist" class="tabs tabs-lift">
        <button role="tab" class="tab" :class="{ 'tab-active': activeTab === 'issues' }"
                @click="activeTab = 'issues'">
          {% translate "Issue Hierarchy" %}
        </button>
        <button role="tab" class="tab" :class="{ 'tab-active': activeTab === 'history' }"
                @click="activeTab = 'history'">
          {% translate "History" %}
        </button>
        <button role="tab" class="tab" :class="{ 'tab-active': activeTab === 'attachments' }"
                @click="activeTab = 'attachments'">
          {% translate "Attachments" %}{% if milestone_attachments %} ({{ milestone_attachments|length }}){% endif %}
        </button>
        <div class="tab flex-1 cursor-default"></div>
      </div>

      <div class="border border-base-300 border-t-0 rounded-b-box p-4">
        {# Issues tab content #}
        <div x-show="activeTab === 'issues'">
          {# HTMX-loaded embedded issues list #}
          <div hx-get="{% url 'milestones:milestone_issues_embed' workspace.slug milestone.project.key milestone.key %}?group_by=epic"
               hx-trigger="load"
               hx-target="this"
               hx-swap="innerHTML">
            <div class="flex justify-center py-8">
              <span class="loading loading-spinner loading-md"></span>
            </div>
          </div>
        </div>

        {# History tab content #}
        <div x-show="activeTab === 'history'" x-cloak>
          <div id="history-section"
               hx-get="{% url 'milestones:milestone_history' workspace.slug milestone.project.key milestone.key %}"
               hx-trigger="intersect once"
               hx-target="this"
               hx-swap="innerHTML">
            <span class="loading loading-spinner loading-md"></span>
          </div>
        </div>

        {# Attachments tab content #}
        <div x-show="activeTab === 'attachments'" x-cloak>
          <div class="mb-4">{% attachment_form milestone %}</div>
          {% if milestone_attachments %}
          <div class="mt-4 space-y-2">
            {% for att in milestone_attachments %}
            <div class="flex items-center gap-3 py-2 border-b border-base-200">
              {% if att|is_image %}
                <a href="{{ att.attachment_file.url }}" target="_blank">
                  <img src="{{ att.attachment_file.url }}" alt="{{ att.filename }}" class="w-20 h-20 object-cover rounded">
                </a>
              {% else %}
                <span class="text-2xl">ðŸ“Ž</span>
              {% endif %}
              <div class="flex-1 min-w-0">
                <a href="{{ att.attachment_file.url }}" target="_blank"
                   class="text-sm font-medium truncate hover:underline">{{ att.filename }}</a>
                <p class="text-xs text-gray-400">{{ att.creator.get_display_name }} Â· {{ att.created|date:"M d, Y" }}</p>
              </div>
              <a href="{{ att.attachment_file.url }}" download class="btn btn-xs btn-outline">{% translate "Download" %}</a>
              {% attachment_delete_link att %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-sm text-gray-400 py-4">{% translate "No attachments yet." %}</p>
          {% endif %}
        </div>
      </div>
    </div>
    {% include "includes/delete_confirm_modal.html" with delete_modal_id="detail-delete-modal-content" %}
    {% include "includes/cascade_status_modal.html" %}
  </section>
  {% endpartialdef page-content %}
</div>
{% endblock %}
