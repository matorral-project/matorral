{% load i18n %}
{# Display mode for issue detail header - click on editable areas triggers edit mode #}
<div id="issue-header"
     class="issue-detail-header"
     x-data
     @click="if ($event.target.closest('.no-edit') === null && !$event.target.closest('a') && !$event.target.closest('button') && !$event.target.closest('.dropdown')) { htmx.ajax('GET', '{% url 'issues:issue_detail_inline_edit' workspace.slug project.key issue.key %}', { target: '#issue-header', swap: 'outerHTML' }) }">
  <div class="flex justify-between items-start mb-4">
    <div class="cursor-pointer group flex-1">
      <div class="flex items-center gap-2 mb-1">
        {% include "issues/includes/issue_type_badge.html" with issue=issue %}
        <span class="font-mono text-sm text-gray-500">{{ issue.key }}</span>
        <span class="invisible group-hover:visible text-xs text-primary">[{% translate "Click to edit" %}]</span>
      </div>
      <h1 class="mt-title">{{ issue.title }}</h1>
    </div>
    <div class="flex items-center gap-2 no-edit">
      {% include "issues/includes/issue_status_badge.html" with status=issue.status status_display=issue.get_status_display %}
      <div class="dropdown dropdown-end">
        <div tabindex="0" role="button" class="btn btn-sm btn-ghost btn-square">
          <i class="fa fa-ellipsis-vertical"></i>
        </div>
        <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-10 w-32 p-2 shadow">
          <li>
            <button type="button" @click="$refs.cloneForm.submit()">
              <i class="fa fa-clone"></i> {% translate "Clone" %}
            </button>
          </li>
          <li>
            <button type="button"
                    hx-get="{% url 'issues:issue_convert' workspace.slug project.key issue.key %}"
                    hx-target="#convert-modal-content"
                    hx-swap="innerHTML"
                    @click="showConvertModal = true; document.activeElement.blur()">
              <i class="fa fa-exchange"></i> {% translate "Convert" %}
            </button>
          </li>
          <li>
            <button type="button"
                    hx-get="{% url 'issues:issue_promote' workspace.slug project.key issue.key %}"
                    hx-target="#promote-modal-content"
                    hx-swap="innerHTML"
                    @click="showPromoteModal = true; document.activeElement.blur()">
              <i class="fa fa-arrow-up"></i> {% translate "Promote to Epic" %}
            </button>
          </li>
          <li>
            <button type="button" class="text-error"
                    hx-get="{% url 'issues:issue_delete' workspace.slug project.key issue.key %}"
                    hx-target="#detail-delete-modal-content"
                    hx-swap="innerHTML"
                    @click="showDeleteModal = true; document.activeElement.blur()">
              <i class="fa fa-trash"></i> {% translate "Delete" %}
            </button>
          </li>
        </ul>
      </div>
      <form x-ref="cloneForm"
            action="{% url 'issues:issue_clone' workspace.slug project.key issue.key %}"
            method="post" class="hidden">
        {% csrf_token %}
      </form>
    </div>
  </div>

  {# Issue fields - 4-column layout #}
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 cursor-pointer">
    <div>
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Priority" %}</h3>
      {% if issue.priority %}
        {% include "issues/includes/issue_priority_badge.html" with priority=issue.priority priority_display=issue.get_priority_display %}
      {% else %}
        <span class="text-gray-400">—</span>
      {% endif %}
    </div>
    {% if is_bug %}
    <div>
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Severity" %}</h3>
      {% if issue.severity %}
        {% include "issues/includes/issue_severity_badge.html" with severity=issue.severity severity_display=issue.get_severity_display %}
      {% else %}
        <span class="text-gray-400">—</span>
      {% endif %}
    </div>
    {% endif %}
    <div>
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Assignee" %}</h3>
      {% if issue.assignee %}
        <p class="text-sm">{{ issue.assignee.get_display_name }}</p>
      {% else %}
        <span class="text-gray-400">—</span>
      {% endif %}
    </div>
    <div>
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Due Date" %}</h3>
      {% if issue.due_date %}
        <p class="text-sm">{{ issue.due_date }}</p>
      {% else %}
        <span class="text-gray-400">—</span>
      {% endif %}
    </div>
    <div>
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Points" %}</h3>
      {% if issue.estimated_points %}
        <p class="text-sm">{{ issue.estimated_points }}</p>
      {% else %}
        <span class="text-gray-400">—</span>
      {% endif %}
    </div>
  </div>

  {# Second row: Parent, Project, Sprint, Creator (read-only links) #}
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
    <div class="cursor-pointer">
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Parent" %}</h3>
      {% if parent %}
        <a href="{{ parent.get_absolute_url }}"
           hx-get="{{ parent.get_absolute_url }}"
           hx-push-url="true"
           class="text-sm link link-primary no-edit">
          {% include "issues/includes/issue_type_badge.html" with issue=parent %}
          {{ parent.key }} - {{ parent.title }}
        </a>
      {% else %}
        <span class="text-gray-400">—</span>
      {% endif %}
    </div>
    <div class="no-edit">
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Project" %}</h3>
      <a href="{{ project.get_absolute_url }}"
         hx-get="{{ project.get_absolute_url }}"
         hx-push-url="true"
         class="text-sm link link-primary">
        {{ project.key }} - {{ project.name }}
      </a>
    </div>
    <div class="no-edit">
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Sprint" %}</h3>
      {% if issue.sprint %}
      <div class="flex items-center gap-2">
        <a href="{{ issue.sprint.get_absolute_url }}"
           hx-get="{{ issue.sprint.get_absolute_url }}"
           hx-push-url="true"
           class="text-sm link link-primary">
          {{ issue.sprint.key }} - {{ issue.sprint.name }}
        </a>
        <form method="post"
              action="{% url 'sprints:sprint_remove_issue' workspace.slug issue.sprint.key issue.key %}"
              class="inline">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ issue.get_absolute_url }}">
          <button type="submit"
                  class="btn btn-xs btn-ghost btn-circle tooltip tooltip-right"
                  data-tip="{% translate "Remove from sprint" %}"
                  hx-post="{% url 'sprints:sprint_remove_issue' workspace.slug issue.sprint.key issue.key %}"
                  hx-vals='{"next": "{{ issue.get_absolute_url }}"}'>
            <i class="fa fa-times text-error"></i>
          </button>
        </form>
      </div>
      {% else %}
      <button type="button"
              class="btn btn-xs btn-ghost"
              hx-get="{% url 'sprints:issue_add_to_sprint' workspace.slug issue.key %}"
              hx-target="#add-to-sprint-modal-content"
              hx-swap="innerHTML"
              @click="showAddToSprintModal = true">
        <i class="fa fa-bolt"></i> {% translate "Add to Sprint" %}
      </button>
      {% endif %}
    </div>
    <div class="no-edit">
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Creator" %}</h3>
      {% if issue.created_by %}
        <p class="text-sm">{{ issue.created_by.get_display_name }}</p>
      {% else %}
        <span class="text-gray-400">—</span>
      {% endif %}
    </div>
  </div>

  <div class="mb-4 cursor-pointer">
    <h3 class="font-semibold mb-2">{% translate "Description" %}</h3>
    {% if issue.description %}
    <p class="text-sm text-gray-600 whitespace-pre-wrap [&_a]:text-primary [&_a]:underline">{{ issue.description|urlize }}</p>
    {% else %}
    <p class="text-sm text-gray-400 italic">{% translate "No description" %}</p>
    {% endif %}
  </div>
</div>
