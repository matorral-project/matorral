{% load i18n %}
<form method="post"
      action="{% url 'issues:issue_convert' workspace.slug project.key issue.key %}"
      x-data="{ targetType: '{{ form.target_type.value|default:'' }}' }">
  {% csrf_token %}
  {% if source %}<input type="hidden" name="source" value="{{ source }}">{% endif %}

  <p class="mb-4">
    {% blocktranslate with key=issue.key type=current_type|title trimmed %}
    Convert <strong>{{ key }}</strong> from <strong>{{ type }}</strong> to:
    {% endblocktranslate %}
  </p>

  {# Type selection #}
  <div class="form-control mb-4">
    <label class="label">
      <span class="label-text font-semibold">{{ form.target_type.label }}</span>
    </label>
    <select name="target_type"
            class="select select-bordered w-full"
            x-model="targetType"
            required>
      {% for value, label in form.target_type.field.choices %}
      <option value="{{ value }}" {% if form.target_type.value == value %}selected{% endif %}>
        {{ label }}
      </option>
      {% endfor %}
    </select>
    {% if form.target_type.errors %}
    <label class="label">
      <span class="label-text-alt text-error">{{ form.target_type.errors.0 }}</span>
    </label>
    {% endif %}
  </div>

  {# Severity field (shown only when Bug is selected) #}
  <div class="form-control mb-4" x-show="targetType === 'bug'" x-cloak>
    <label class="label">
      <span class="label-text font-semibold">{{ form.severity.label }}</span>
    </label>
    <select name="severity" class="select select-bordered w-full">
      {% for value, label in form.severity.field.choices %}
      <option value="{{ value }}" {% if form.severity.value == value %}selected{% endif %}>
        {{ label }}
      </option>
      {% endfor %}
    </select>
    <label class="label">
      <span class="label-text-alt">{{ form.severity.help_text }}</span>
    </label>
  </div>

  {# Warning about data loss when converting FROM Bug #}
  {% if current_type == "bug" %}
  <div class="alert alert-warning mb-4">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    </svg>
    <span class="text-sm">{% translate "Severity will be lost when converting from Bug." %}</span>
  </div>
  {% endif %}

  <p class="text-sm text-base-content/70 mb-4">
    {% translate "Comments, subtasks, and history will be preserved." %}
  </p>

  <div class="modal-action">
    <button type="button" class="btn btn-ghost" @click="showConvertModal = false">
      {% translate "Cancel" %}
    </button>
    <button type="submit" class="btn btn-primary"
            hx-post="{% url 'issues:issue_convert' workspace.slug project.key issue.key %}"
            hx-target="#convert-modal-content"
            hx-swap="innerHTML">
      {% translate "Convert" %}
    </button>
  </div>
</form>
