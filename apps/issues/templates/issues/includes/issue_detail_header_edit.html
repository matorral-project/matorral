{% load i18n %}
{# Edit mode for issue detail header - form inputs for inline editing #}
<div id="issue-header"
     class="issue-detail-header-edit bg-base-200 rounded-lg p-4"
     x-data
     @keydown.escape="htmx.ajax('GET', '{% url 'issues:issue_detail_inline_edit' workspace.slug project.key issue.key %}?cancel=1', { target: $el, swap: 'outerHTML' })">
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

  <div class="flex justify-between items-start mb-4">
    <div class="flex-1">
      <div class="flex items-center gap-2 mb-2">
        {% include "issues/includes/issue_type_badge.html" with issue=issue %}
        <span class="font-mono text-sm text-gray-500">{{ issue.key }}</span>
      </div>
      <input type="text"
             name="title"
             value="{{ issue.title }}"
             class="input input-bordered w-full text-xl font-bold {% if form.title.errors %}input-error{% endif %}"
             placeholder="{% translate 'Issue title' %}"
             required
             autofocus>
      {% if form.title.errors %}
      <span class="text-error text-xs">{{ form.title.errors.0 }}</span>
      {% endif %}
    </div>
  </div>

  {# Issue fields - 4-column layout #}
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
    <div>
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Priority" %}</h3>
      <select name="priority"
              class="select select-bordered select-sm w-full">
        <option value="">—</option>
        {% for value, label in priority_choices %}
        <option value="{{ value }}" {% if issue.priority == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    {% if is_bug %}
    <div>
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Severity" %}</h3>
      <select name="severity"
              class="select select-bordered select-sm w-full">
        {% for value, label in severity_choices %}
        <option value="{{ value }}" {% if issue.severity == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
    <div>
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Assignee" %}</h3>
      {% include "includes/user_combobox.html" with combobox_name="assignee" combobox_members=workspace_members combobox_selected_id=issue.assignee_id|default:"" combobox_selected_name=issue.assignee.get_display_name|default:"" combobox_size="sm" %}
    </div>
    <div>
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Due Date" %}</h3>
      <input type="date"
             name="due_date"
             value="{{ issue.due_date|date:'Y-m-d' }}"
             class="input input-bordered input-sm w-full">
    </div>
    <div>
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Points" %}</h3>
      <input type="number"
             name="estimated_points"
             value="{{ issue.estimated_points|default:'' }}"
             min="0"
             class="input input-bordered input-sm w-full"
             placeholder="—">
    </div>
  </div>

  {# Second row: Status, Parent, Project (read-only), Sprint (read-only) #}
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
    <div>
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Status" %}</h3>
      <select name="status"
              class="select select-bordered select-sm w-full {% if form.status.errors %}select-error{% endif %}">
        {% for value, label in status_choices %}
        <option value="{{ value }}" {% if issue.status == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      {% if form.status.errors %}
      <span class="text-error text-xs">{{ form.status.errors.0 }}</span>
      {% endif %}
    </div>
    <div>
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Parent" %}</h3>
      <select name="parent"
              class="select select-bordered select-sm w-full">
        <option value="">—</option>
        {% for epic in epics %}
        <option value="{{ epic.pk }}" {% if parent and parent.pk == epic.pk %}selected{% endif %}>{{ epic.key }} - {{ epic.title }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Project" %}</h3>
      <p class="text-sm py-1">{{ project.key }} - {{ project.name }}</p>
    </div>
    <div>
      <h3 class="font-semibold mb-1 text-sm text-gray-500">{% translate "Sprint" %}</h3>
      {% if issue.sprint %}
      <p class="text-sm py-1">{{ issue.sprint.key }} - {{ issue.sprint.name }}</p>
      {% else %}
      <p class="text-sm py-1 text-gray-400">—</p>
      {% endif %}
    </div>
  </div>

  <div class="mb-4">
    <h3 class="font-semibold mb-2">{% translate "Description" %}</h3>
    <textarea name="description"
              class="textarea textarea-bordered w-full {% if form.description.errors %}textarea-error{% endif %}"
              rows="3"
              placeholder="{% translate 'Add a description...' %}">{{ issue.description }}</textarea>
    {% if form.description.errors %}
    <span class="text-error text-xs">{{ form.description.errors.0 }}</span>
    {% endif %}
  </div>

  <div class="flex gap-2">
    <button type="button"
            class="btn btn-success"
            hx-post="{% url 'issues:issue_detail_inline_edit' workspace.slug project.key issue.key %}"
            hx-include="#issue-header"
            hx-target="#issue-header"
            hx-swap="outerHTML">
      <i class="fa fa-check"></i> {% translate "Save" %}
    </button>
    <button type="button"
            class="btn btn-ghost"
            hx-get="{% url 'issues:issue_detail_inline_edit' workspace.slug project.key issue.key %}?cancel=1"
            hx-target="#issue-header"
            hx-swap="outerHTML">
      <i class="fa fa-times"></i> {% translate "Cancel" %}
    </button>
  </div>
</div>
