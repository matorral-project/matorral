{% load i18n issues_tags %}
<div id="issues-embed">
  {% partialdef embed-content inline %}
  <section class="relative"
           x-data="issuesEmbed()"
           @htmx:after-swap="selectedCount = document.querySelectorAll('#issues-embed [name=issues]:checked').length"
           @show-cascade-modal.document="showEditModal = false"
           @issue-created.window="showNewIssueModal = false; htmx.ajax('GET', $event.detail.embedUrl, {target: '#issues-embed', swap: 'innerHTML'})"
           @epic-created.window="showNewEpicModal = false; htmx.ajax('GET', $event.detail.embedUrl, {target: '#issues-embed', swap: 'innerHTML'})"
           @milestone-created.window="showNewMilestoneModal = false; htmx.ajax('GET', $event.detail.embedUrl, {target: '#issues-embed', swap: 'innerHTML'})"
           @filters-apply="
             htmx.ajax('GET', '{{ embed_url }}?' + new URLSearchParams({
               status: $event.detail.status || '',
               type: $event.detail.type || '',
               priority: $event.detail.priority || '',
               assignee: $event.detail.assignee || '',
               sprint: $event.detail.sprint || '',
               sort_by: $event.detail.sort_by || '',
               group_by: '{{ group_by|default:"" }}',
               search: '{{ search_query|default:"" }}'
             }).toString(), {target: '#issues-embed', swap: 'innerHTML'})
           ">
    <div class="flex justify-between items-center pb-4 sticky top-0 z-10 bg-base-100">
      <div class="flex items-center gap-4">
        {# Search and filters - hidden when issues are selected #}
        <div class="flex items-center gap-2" x-show="selectedCount === 0" x-cloak>
          {% translate "Search issues..." as placeholder %}
          {% json_vals status=status_filter type=type_filter priority=priority_filter assignee=assignee_filter sprint=sprint_filter group_by=group_by as hx_vals %}
          {% include "includes/search_input.html" with input_id="embed-search-input" search_url=embed_url hx_target="#issues-list" hx_indicator="#embed-list-loading" placeholder=placeholder hx_vals=hx_vals %}
          <button type="button"
                  class="btn btn-sm {% if active_filter_count %}btn-primary{% else %}btn-outline{% endif %}"
                  @click="showFiltersModal = true">
            {% translate "Filters" %}
            <i class="fa-solid fa-filter ml-1"></i>
            {% if active_filter_count %}
            <span class="badge badge-sm">{{ active_filter_count }}</span>
            {% endif %}
          </button>
          {% if active_filter_count %}
          <button type="button"
                  class="btn btn-sm btn-ghost btn-square"
                  title="{% translate "Clear filters" %}"
                  hx-get="{{ embed_url }}"
                  hx-vals='{"search": "{{ search_query|default:"" }}", "group_by": "{{ group_by|default:"" }}", "sprint": ""}'
                  hx-target="#issues-embed"
                  hx-swap="innerHTML"
                  hx-indicator="#embed-list-loading">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
            </svg>
          </button>
          {% endif %}
          <div class="dropdown">
            <div tabindex="0" role="button" class="btn btn-sm {% if group_by %}btn-primary{% else %}btn-outline{% endif %}">
              {% if group_by_label %}
                {% translate "Group:" %} {{ group_by_label }}
              {% else %}
                {% translate "Group by" %}
              {% endif %}
              <i class="fa fa-chevron-down ml-1"></i>
            </div>
            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-10 w-40 p-2 shadow">
              <li>
                <button type="button"
                        {% if not group_by %}class="active"{% endif %}
                        @click="htmx.ajax('GET', '{{ embed_url }}?' + new URLSearchParams({status: '{{ status_filter|default:"" }}', type: '{{ type_filter|default:"" }}', priority: '{{ priority_filter|default:"" }}', assignee: '{{ assignee_filter|default:"" }}', sprint: '{{ sprint_filter|default:"" }}', sort_by: '{{ sort_by|default:"" }}', group_by: '', search: '{{ search_query|default:"" }}'}).toString(), {target: '#issues-embed', swap: 'innerHTML'}); document.activeElement.blur()">
                  {% translate "None" %}
                </button>
              </li>
              {% for group_value, group_label in group_by_choices %}
              <li>
                <button type="button"
                        {% if group_by == group_value %}class="active"{% endif %}
                        @click="htmx.ajax('GET', '{{ embed_url }}?' + new URLSearchParams({status: '{{ status_filter|default:"" }}', type: '{{ type_filter|default:"" }}', priority: '{{ priority_filter|default:"" }}', assignee: '{{ assignee_filter|default:"" }}', sprint: '{{ sprint_filter|default:"" }}', sort_by: '{{ sort_by|default:"" }}', group_by: '{{ group_value }}', search: '{{ search_query|default:"" }}'}).toString(), {target: '#issues-embed', swap: 'innerHTML'}); document.activeElement.blur()">
                  {{ group_label }}
                </button>
              </li>
              {% endfor %}
            </ul>
          </div>
          {% if not group_by %}
          <div class="dropdown">
            <div tabindex="0" role="button" class="btn btn-sm {% if sort_by %}btn-primary{% else %}btn-outline{% endif %}">
              {% if sort_by_label %}
                {% translate "Sort:" %} {{ sort_by_label }}
              {% else %}
                {% translate "Sort by" %}
              {% endif %}
              <i class="fa fa-chevron-down ml-1"></i>
            </div>
            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-10 w-48 p-2 shadow">
              <li>
                <button type="button"
                        {% if not sort_by %}class="active"{% endif %}
                        @click="htmx.ajax('GET', '{{ embed_url }}?' + new URLSearchParams({status: '{{ status_filter|default:"" }}', type: '{{ type_filter|default:"" }}', priority: '{{ priority_filter|default:"" }}', assignee: '{{ assignee_filter|default:"" }}', sprint: '{{ sprint_filter|default:"" }}', sort_by: '', group_by: '{{ group_by|default:"" }}', search: '{{ search_query|default:"" }}'}).toString(), {target: '#issues-embed', swap: 'innerHTML'}); document.activeElement.blur()">
                  {% translate "Default" %}
                </button>
              </li>
              {% for sort_value, sort_label in sort_by_choices %}
              <li>
                <button type="button"
                        {% if sort_by == sort_value %}class="active"{% endif %}
                        @click="htmx.ajax('GET', '{{ embed_url }}?' + new URLSearchParams({status: '{{ status_filter|default:"" }}', type: '{{ type_filter|default:"" }}', priority: '{{ priority_filter|default:"" }}', assignee: '{{ assignee_filter|default:"" }}', sprint: '{{ sprint_filter|default:"" }}', sort_by: '{{ sort_value }}', group_by: '{{ group_by|default:"" }}', search: '{{ search_query|default:"" }}'}).toString(), {target: '#issues-embed', swap: 'innerHTML'}); document.activeElement.blur()">
                  {{ sort_label }}
                </button>
              </li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        </div>
      </div>
      {# Header right button - context dependent #}
      {% if sprint %}
      <div class="flex items-center gap-2" x-show="selectedCount === 0" x-cloak>
        <button type="button"
                class="mt-button-primary"
                hx-get="{% url 'sprints:sprint_add_issues' workspace.slug sprint.key %}"
                hx-target="#add-issues-modal-content"
                hx-swap="innerHTML"
                @click="showAddIssuesModal = true">
          <span class="mt-icon"><i class="fa fa-plus"></i></span>
          <span>{% translate "Add Issues" %}</span>
        </button>
      </div>
      {% elif epic %}
      {# Epic context - show new issue dropdown that opens modal #}
      <div class="flex items-center gap-2" x-show="selectedCount === 0" x-cloak>
        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button" class="mt-button-primary">
            <span class="mt-icon"><i class="fa fa-plus"></i></span>
            <span>{% translate "New" %}</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
          <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-10 w-40 p-2 shadow-md">
            <li>
              <button type="button"
                      hx-get="{% url 'issues:epic_new_issue' workspace.slug project.key epic.key 'story' %}?modal=1"
                      hx-target="#new-issue-modal-content"
                      hx-swap="innerHTML"
                      @click="newIssueModalTitle = '{% translate "New Story" %}'; showNewIssueModal = true; document.activeElement.blur()">
                <i class="fa fa-book text-info"></i>
                {% translate "Story" %}
              </button>
            </li>
            <li>
              <button type="button"
                      hx-get="{% url 'issues:epic_new_issue' workspace.slug project.key epic.key 'bug' %}?modal=1"
                      hx-target="#new-issue-modal-content"
                      hx-swap="innerHTML"
                      @click="newIssueModalTitle = '{% translate "New Bug" %}'; showNewIssueModal = true; document.activeElement.blur()">
                <i class="fa fa-bug text-error"></i>
                {% translate "Bug" %}
              </button>
            </li>
            <li>
              <button type="button"
                      hx-get="{% url 'issues:epic_new_issue' workspace.slug project.key epic.key 'chore' %}?modal=1"
                      hx-target="#new-issue-modal-content"
                      hx-swap="innerHTML"
                      @click="newIssueModalTitle = '{% translate "New Chore" %}'; showNewIssueModal = true; document.activeElement.blur()">
                <i class="fa fa-wrench text-warning"></i>
                {% translate "Chore" %}
              </button>
            </li>
          </ul>
        </div>
      </div>
      {% elif milestone %}
      {# Milestone context - show New Epic button that opens modal #}
      <div class="flex items-center gap-2" x-show="selectedCount === 0" x-cloak>
        <button type="button"
                class="mt-button-primary"
                hx-get="{% url 'milestones:milestone_new_epic' workspace.slug milestone.project.key milestone.key %}?modal=1"
                hx-target="#new-epic-modal-content"
                hx-swap="innerHTML"
                @click="showNewEpicModal = true">
          <span class="mt-icon"><i class="fa fa-plus"></i></span>
          <span>{% translate "New Epic" %}</span>
        </button>
      </div>
      {% elif project_orphan %}
      {# Project orphan context - show New dropdown with Milestone, Epic, Story, Bug, Chore #}
      <div class="flex items-center gap-2" x-show="selectedCount === 0" x-cloak>
        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button" class="mt-button-primary">
            <span class="mt-icon"><i class="fa fa-plus"></i></span>
            <span>{% translate "New" %}</span>
            <i class="fa fa-chevron-down ml-1"></i>
          </div>
          <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-10 w-44 p-2 shadow">
            <li>
              <button type="button"
                      hx-get="{% url 'projects:project_milestone_create' workspace.slug project.key %}?modal=1"
                      hx-target="#{{ embed_modal_prefix }}new-milestone-modal-content"
                      hx-swap="innerHTML"
                      @click="showNewMilestoneModal = true; document.activeElement.blur()">
                <i class="fa fa-flag text-secondary"></i>
                {% translate "Milestone" %}
              </button>
            </li>
            <li>
              <button type="button"
                      hx-get="{% url 'projects:project_epic_create' workspace.slug project.key %}?modal=1"
                      hx-target="#{{ embed_modal_prefix }}new-epic-modal-content"
                      hx-swap="innerHTML"
                      @click="showNewEpicModal = true; document.activeElement.blur()">
                <i class="fa fa-layer-group text-accent"></i>
                {% translate "Epic" %}
              </button>
            </li>
            <div class="divider my-0"></div>
            <li>
              <button type="button"
                      hx-get="{% url 'projects:project_issue_create_typed' workspace.slug project.key 'story' %}?modal=1"
                      hx-target="#{{ embed_modal_prefix }}new-issue-modal-content"
                      hx-swap="innerHTML"
                      @click="newIssueModalTitle = '{% translate "New Story" %}'; showNewIssueModal = true; document.activeElement.blur()">
                <i class="fa fa-book text-info"></i>
                {% translate "Story" %}
              </button>
            </li>
            <li>
              <button type="button"
                      hx-get="{% url 'projects:project_issue_create_typed' workspace.slug project.key 'bug' %}?modal=1"
                      hx-target="#{{ embed_modal_prefix }}new-issue-modal-content"
                      hx-swap="innerHTML"
                      @click="newIssueModalTitle = '{% translate "New Bug" %}'; showNewIssueModal = true; document.activeElement.blur()">
                <i class="fa fa-bug text-error"></i>
                {% translate "Bug" %}
              </button>
            </li>
            <li>
              <button type="button"
                      hx-get="{% url 'projects:project_issue_create_typed' workspace.slug project.key 'chore' %}?modal=1"
                      hx-target="#{{ embed_modal_prefix }}new-issue-modal-content"
                      hx-swap="innerHTML"
                      @click="newIssueModalTitle = '{% translate "New Chore" %}'; showNewIssueModal = true; document.activeElement.blur()">
                <i class="fa fa-wrench text-warning"></i>
                {% translate "Chore" %}
              </button>
            </li>
          </ul>
        </div>
      </div>
      {% else %}
      <div class="flex items-center gap-2" x-show="selectedCount === 0" x-cloak>
        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button" class="mt-button-primary">
            <span class="mt-icon"><i class="fa fa-plus"></i></span>
            <span>{% translate "New" %}</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
          <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-10 w-40 p-2 shadow-md">
            <li>
              <a href="{% url 'issues:issue_create_typed' workspace.slug project.key 'epic' %}?project={{ project.key }}&next={{ project.get_absolute_url|urlencode }}"
                 hx-get="{% url 'issues:issue_create_typed' workspace.slug project.key 'epic' %}?project={{ project.key }}&next={{ project.get_absolute_url|urlencode }}"
                 hx-target="#page-content"
                 hx-push-url="true">
                <i class="fa fa-bolt text-secondary"></i>
                {% translate "Epic" %}
              </a>
            </li>
            <li class="py-1 pointer-events-none"><hr class="border-base-300"></li>
            <li>
              <a href="{% url 'issues:issue_create_typed' workspace.slug project.key 'story' %}?project={{ project.key }}&next={{ project.get_absolute_url|urlencode }}"
                 hx-get="{% url 'issues:issue_create_typed' workspace.slug project.key 'story' %}?project={{ project.key }}&next={{ project.get_absolute_url|urlencode }}"
                 hx-target="#page-content"
                 hx-push-url="true">
                <i class="fa fa-book text-info"></i>
                {% translate "Story" %}
              </a>
            </li>
            <li>
              <a href="{% url 'issues:issue_create_typed' workspace.slug project.key 'bug' %}?project={{ project.key }}&next={{ project.get_absolute_url|urlencode }}"
                 hx-get="{% url 'issues:issue_create_typed' workspace.slug project.key 'bug' %}?project={{ project.key }}&next={{ project.get_absolute_url|urlencode }}"
                 hx-target="#page-content"
                 hx-push-url="true">
                <i class="fa fa-bug text-error"></i>
                {% translate "Bug" %}
              </a>
            </li>
            <li>
              <a href="{% url 'issues:issue_create_typed' workspace.slug project.key 'chore' %}?project={{ project.key }}&next={{ project.get_absolute_url|urlencode }}"
                 hx-get="{% url 'issues:issue_create_typed' workspace.slug project.key 'chore' %}?project={{ project.key }}&next={{ project.get_absolute_url|urlencode }}"
                 hx-target="#page-content"
                 hx-push-url="true">
                <i class="fa fa-wrench text-warning"></i>
                {% translate "Chore" %}
              </a>
            </li>
          </ul>
        </div>
      </div>
      {% endif %}
      {# Bulk actions - shown when at least one issue is selected #}
      <div class="flex items-center gap-2" x-show="selectedCount > 0" x-cloak>
        <span class="text-sm text-base-content/70" x-text="selectedCount + ' {% translate "selected" %}'"></span>
        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button" class="btn btn-sm btn-outline">
            <i class="fa fa-flag mr-1"></i>
            {% translate "Set Status" %}
            <i class="fa fa-chevron-down ml-1"></i>
          </div>
          <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-10 w-40 p-2 shadow">
            {% for status_value, status_label in status_choices %}
            <li>
              <button type="button"
                      hx-post="{% url 'workspace_issues_bulk_status' workspace.slug %}"
                      hx-vals='{% if sprint %}{"status": "{{ status_value }}", "page": "{{ page_obj.number|default:1 }}", "search": "{{ search_query|default:"" }}", "status_filter": "{{ status_filter|default:"" }}", "assignee_filter": "{{ assignee_filter|default:"" }}", "group_by": "{{ group_by|default:"" }}", "sprint_filter": "{{ sprint.key }}", "embed": "sprint"}{% elif epic %}{"status": "{{ status_value }}", "page": "{{ page_obj.number|default:1 }}", "search": "{{ search_query|default:"" }}", "status_filter": "{{ status_filter|default:"" }}", "assignee_filter": "{{ assignee_filter|default:"" }}", "sprint_filter": "{{ sprint_filter|default:"" }}", "group_by": "{{ group_by|default:"" }}", "project_filter": "{{ project.key }}", "epic_filter": "{{ epic.key }}", "embed": "epic"}{% elif milestone %}{"status": "{{ status_value }}", "page": "{{ page_obj.number|default:1 }}", "search": "{{ search_query|default:"" }}", "status_filter": "{{ status_filter|default:"" }}", "assignee_filter": "{{ assignee_filter|default:"" }}", "sprint_filter": "{{ sprint_filter|default:"" }}", "group_by": "{{ group_by|default:"" }}", "project_filter": "{{ project.key }}", "milestone_filter": "{{ milestone.key }}", "embed": "milestone"}{% elif project_orphan %}{"status": "{{ status_value }}", "page": "{{ page_obj.number|default:1 }}", "search": "{{ search_query|default:"" }}", "status_filter": "{{ status_filter|default:"" }}", "type_filter": "{{ type_filter|default:"" }}", "priority_filter": "{{ priority_filter|default:"" }}", "assignee_filter": "{{ assignee_filter|default:"" }}", "sprint_filter": "{{ sprint_filter|default:"" }}", "group_by": "{{ group_by|default:"" }}", "project_filter": "{{ project.key }}", "embed": "project_orphan"}{% endif %}'
                      hx-include="#issues-embed [name='issues']:checked"
                      hx-target="#issues-embed"
                      hx-swap="innerHTML"
                      hx-indicator="#embed-list-loading"
                      hx-disabled-elt="this"
                      @click="document.activeElement.blur()">
                {{ status_label }}
              </button>
            </li>
            {% endfor %}
          </ul>
        </div>
        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button" class="btn btn-sm btn-outline">
            <i class="fa fa-arrow-up mr-1"></i>
            {% translate "Set Priority" %}
            <i class="fa fa-chevron-down ml-1"></i>
          </div>
          <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-10 w-40 p-2 shadow">
            {% for priority_value, priority_label in priority_choices %}
            <li>
              <button type="button"
                      hx-post="{% url 'workspace_issues_bulk_priority' workspace.slug %}"
                      hx-vals='{% if sprint %}{"priority": "{{ priority_value }}", "page": "{{ page_obj.number|default:1 }}", "search": "{{ search_query|default:"" }}", "status_filter": "{{ status_filter|default:"" }}", "assignee_filter": "{{ assignee_filter|default:"" }}", "group_by": "{{ group_by|default:"" }}", "sprint_filter": "{{ sprint.key }}", "embed": "sprint"}{% elif epic %}{"priority": "{{ priority_value }}", "page": "{{ page_obj.number|default:1 }}", "search": "{{ search_query|default:"" }}", "status_filter": "{{ status_filter|default:"" }}", "assignee_filter": "{{ assignee_filter|default:"" }}", "sprint_filter": "{{ sprint_filter|default:"" }}", "group_by": "{{ group_by|default:"" }}", "project_filter": "{{ project.key }}", "epic_filter": "{{ epic.key }}", "embed": "epic"}{% elif milestone %}{"priority": "{{ priority_value }}", "page": "{{ page_obj.number|default:1 }}", "search": "{{ search_query|default:"" }}", "status_filter": "{{ status_filter|default:"" }}", "assignee_filter": "{{ assignee_filter|default:"" }}", "sprint_filter": "{{ sprint_filter|default:"" }}", "group_by": "{{ group_by|default:"" }}", "project_filter": "{{ project.key }}", "milestone_filter": "{{ milestone.key }}", "embed": "milestone"}{% elif project_orphan %}{"priority": "{{ priority_value }}", "page": "{{ page_obj.number|default:1 }}", "search": "{{ search_query|default:"" }}", "status_filter": "{{ status_filter|default:"" }}", "type_filter": "{{ type_filter|default:"" }}", "priority_filter": "{{ priority_filter|default:"" }}", "assignee_filter": "{{ assignee_filter|default:"" }}", "sprint_filter": "{{ sprint_filter|default:"" }}", "group_by": "{{ group_by|default:"" }}", "project_filter": "{{ project.key }}", "embed": "project_orphan"}{% endif %}'
                      hx-include="#issues-embed [name='issues']:checked"
                      hx-target="#issues-embed"
                      hx-swap="innerHTML"
                      hx-indicator="#embed-list-loading"
                      hx-disabled-elt="this"
                      @click="document.activeElement.blur()">
                {{ priority_label }}
              </button>
            </li>
            {% endfor %}
          </ul>
        </div>
        <button type="button"
                class="btn btn-sm btn-outline"
                @click="document.getElementById('embed-assignee-none').checked = true; assigneeConfirmStep = false; selectedAssigneeName = '{% translate "Unassigned" %}'; selectedAssigneeValue = ''; showBulkAssigneeModal = true">
          <i class="fa fa-user mr-1"></i>
          {% translate "Set Assignee" %}
        </button>
        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button" class="btn btn-sm btn-ghost btn-square">
            <i class="fa fa-ellipsis-vertical"></i>
          </div>
          <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-10 w-52 p-2 shadow">
            {% if sprint %}
            <li>
              <button type="button"
                      class="text-error"
                      @click="showBulkRemoveFromSprintModal = true; document.activeElement.blur()">
                <i class="fa fa-times"></i>
                {% translate "Remove from Sprint" %}
              </button>
            </li>
            {% else %}
            {% if available_sprints %}
            <li>
              <button type="button"
                      @click="sprintConfirmStep = false; selectedSprintName = '{{ available_sprints.0.name }}'; selectedSprintValue = '{{ available_sprints.0.key }}'; showBulkAddToSprintModal = true; document.activeElement.blur()">
                <i class="fa fa-bolt"></i>
                {% translate "Add to Sprint" %}
              </button>
            </li>
            {% endif %}
            {% endif %}
            <li>
              <button type="button"
                      class="text-error"
                      hx-post="{% url 'workspace_issues_bulk_delete_preview' workspace.slug %}"
                      hx-vals='{% if sprint %}{"page": "{{ page_obj.number|default:1 }}", "search": "{{ search_query|default:"" }}", "status_filter": "{{ status_filter|default:"" }}", "assignee_filter": "{{ assignee_filter|default:"" }}", "group_by": "{{ group_by|default:"" }}", "sprint_filter": "{{ sprint.key }}", "embed": "sprint"}{% elif epic %}{"page": "{{ page_obj.number|default:1 }}", "search": "{{ search_query|default:"" }}", "status_filter": "{{ status_filter|default:"" }}", "assignee_filter": "{{ assignee_filter|default:"" }}", "group_by": "{{ group_by|default:"" }}", "project_filter": "{{ project.key }}", "epic_filter": "{{ epic.key }}", "embed": "epic"}{% elif milestone %}{"page": "{{ page_obj.number|default:1 }}", "search": "{{ search_query|default:"" }}", "status_filter": "{{ status_filter|default:"" }}", "assignee_filter": "{{ assignee_filter|default:"" }}", "group_by": "{{ group_by|default:"" }}", "project_filter": "{{ project.key }}", "milestone_filter": "{{ milestone.key }}", "embed": "milestone"}{% elif project_orphan %}{"page": "{{ page_obj.number|default:1 }}", "search": "{{ search_query|default:"" }}", "status_filter": "{{ status_filter|default:"" }}", "type_filter": "{{ type_filter|default:"" }}", "priority_filter": "{{ priority_filter|default:"" }}", "assignee_filter": "{{ assignee_filter|default:"" }}", "sprint_filter": "{{ sprint_filter|default:"" }}", "group_by": "{{ group_by|default:"" }}", "project_filter": "{{ project.key }}", "embed": "project_orphan"}{% endif %}'
                      hx-include="#issues-embed [name='issues']:checked"
                      hx-target="#embed-bulk-delete-modal-content"
                      hx-swap="innerHTML"
                      @click="showBulkDeleteModal = true; document.activeElement.blur()">
                <i class="fa fa-trash"></i>
                {% translate "Delete" %}
              </button>
            </li>
          </ul>
        </div>
      </div>
    </div>
    {% include "includes/loading_indicator.html" with indicator_id="embed-list-loading" %}
    <div id="issues-list">
      {% partialdef list-content inline %}
      {% if group_by and grouped_issues %}
      {# Grouped view #}
      <div class="space-y-4">
        {% for group in grouped_issues %}
        <div class="bg-base-200 rounded-box">
          <div class="px-4 py-3 font-medium">
            <div class="flex items-center justify-between">
              {% if group_by == "epic" and group.epic %}
              <a href="{{ group.epic.get_absolute_url }}"
                 hx-get="{{ group.epic.get_absolute_url }}"
                 hx-target="#page-content"
                 hx-push-url="true"
                 class="link link-hover">
                {{ group.name }}
              </a>
              {% elif group_by == "sprint" and group.sprint %}
              <a href="{{ group.sprint.get_absolute_url }}"
                 hx-get="{{ group.sprint.get_absolute_url }}"
                 hx-target="#page-content"
                 hx-push-url="true"
                 class="link link-hover">
                {{ group.name }}
              </a>
              {% else %}
              <span>{{ group.name }}</span>
              {% endif %}
              {% if group_by == "epic" and group.epic %}
              <div class="flex items-center gap-2">
                {# Progress bar #}
                {% if group.progress %}
                {% include "issues/includes/progress_bar.html" with progress=group.progress compact=True %}
                {% endif %}
                {# Status and Priority badges #}
                <div class="flex gap-2 [&_.badge]:badge-sm">
                  {% include "issues/includes/issue_status_badge.html" with status=group.epic.status status_display=group.epic.get_status_display %}
                  {% include "issues/includes/issue_priority_badge.html" with priority=group.epic.priority priority_display=group.epic.get_priority_display %}
                </div>
                {# Actions dropdown #}
                <div class="dropdown dropdown-end">
                  <div tabindex="0" role="button" class="btn btn-sm btn-ghost btn-square tooltip tooltip-left" data-tip="{% translate "Actions" %}">
                    <i class="fa fa-ellipsis-vertical"></i>
                  </div>
                  <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-10 w-40 p-2 shadow">
                    <li>
                      <a href="{{ group.epic.get_absolute_url }}"
                         hx-get="{{ group.epic.get_absolute_url }}"
                         hx-target="#page-content"
                         hx-push-url="true">
                        <i class="fa fa-eye"></i> {% translate "View" %}
                      </a>
                    </li>
                    <li>
                      <button type="button"
                              hx-get="{{ group.epic.get_absolute_url }}?quick_view=1"
                              hx-target="#quick-view-modal-content"
                              hx-swap="innerHTML"
                              @click="showQuickViewModal = true; document.activeElement.blur()">
                        <i class="fa fa-eye"></i> {% translate "Quick View" %}
                      </button>
                    </li>
                    <li>
                      <button type="button"
                              hx-get="{% url 'issues:issue_update' workspace.slug group.epic.project.key group.epic.key %}?project={{ group.epic.project.key }}&modal=1"
                              hx-target="#edit-modal-content"
                              hx-swap="innerHTML"
                              @click="showEditModal = true; document.activeElement.blur()">
                        <i class="fa fa-pencil"></i> {% translate "Edit" %}
                      </button>
                    </li>
                    <li>
                      <button type="button"
                              @click="actionModalType = 'clone'; actionModalTitle = '{% translate "Clone Epic" %}'; actionModalMessage = '{% translate "Are you sure you want to clone this epic?" %}'; actionModalConfirmText = '{% translate "Clone" %}'; actionModalUrl = '{% url 'issues:issue_clone' workspace.slug group.epic.project.key group.epic.key %}'; showActionModal = true; document.activeElement.blur()">
                        <i class="fa fa-clone"></i> {% translate "Clone" %}
                      </button>
                    </li>
                    <li>
                      <button type="button" class="text-error"
                              hx-get="{% url 'issues:issue_delete' workspace.slug group.epic.project.key group.epic.key %}"
                              hx-target="#delete-modal-content"
                              hx-swap="innerHTML"
                              @click="showDeleteModal = true; document.activeElement.blur()">
                        <i class="fa fa-trash"></i> {% translate "Delete" %}
                      </button>
                    </li>
                  </ul>
                </div>
              </div>
              {% elif group_by == "sprint" and group.sprint %}
              <div class="flex items-center gap-2">
                {# Sprint status badge #}
                <div class="flex gap-2 [&_.badge]:badge-sm">
                  {% include "sprints/includes/sprint_status_badge.html" with status=group.sprint.status status_display=group.sprint.get_status_display %}
                </div>
                {# Actions dropdown #}
                <div class="dropdown dropdown-end">
                  <div tabindex="0" role="button" class="btn btn-sm btn-ghost btn-square tooltip tooltip-left" data-tip="{% translate "Actions" %}">
                    <i class="fa fa-ellipsis-vertical"></i>
                  </div>
                  <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-10 w-32 p-2 shadow">
                    <li>
                      <a href="{{ group.sprint.get_absolute_url }}"
                         hx-get="{{ group.sprint.get_absolute_url }}"
                         hx-target="#page-content"
                         hx-push-url="true">
                        <i class="fa fa-eye"></i> {% translate "View" %}
                      </a>
                    </li>
                    <li>
                      <a href="{% url 'sprints:sprint_update' workspace.slug group.sprint.key %}"
                         hx-get="{% url 'sprints:sprint_update' workspace.slug group.sprint.key %}"
                         hx-target="#page-content"
                         hx-push-url="true">
                        <i class="fa fa-pencil"></i> {% translate "Edit" %}
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          <div class="bg-base-100 rounded-b-box">
            <div class="table-responsive">
              <table class="table mt-table">
                <thead>
                  <tr>
                    <th class="w-10">
                      <input type="checkbox"
                             class="checkbox checkbox-sm embed-group-select"
                             data-group="{{ forloop.counter }}"
                             @change="
                               document.querySelectorAll('#issues-embed [data-group-row=\'{{ forloop.counter }}\']').forEach(cb => cb.checked = $event.target.checked);
                               selectedCount = document.querySelectorAll('#issues-embed [name=issues]:checked').length;
                             ">
                    </th>
                    <th>{% translate "Key" %}</th>
                    <th>{% translate "Type" %}</th>
                    <th>{% translate "Title" %}</th>
                    {% if sprint and group_by != "project" %}<th>{% translate "Project" %}</th>{% endif %}
                    {% if group_by != "status" %}<th>{% translate "Status" %}</th>{% endif %}
                    {% if group_by != "priority" %}<th>{% translate "Priority" %}</th>{% endif %}
                    {% if group_by != "assignee" %}<th>{% translate "Assignee" %}</th>{% endif %}
                    <th>{% translate "Points" %}</th>
                    <th class="w-10"></th>
                  </tr>
                </thead>
                <tbody>
                  {% for issue in group.issues %}
                  {% include "issues/includes/issue_row_embed.html" with issue=issue group_row_counter=forloop.parentloop.counter %}
                  {% empty %}
                  <tr>
                    <td colspan="9" class="text-left text-base-content/50 py-4">{% translate "No issues for now." %}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% if not sprint and group_by == "epic" and milestone %}
            {# Add issue button for epic groups - opens modal #}
            <div class="flex justify-end px-4 py-2 border-t border-base-200">
              <div class="dropdown dropdown-end dropdown-top tooltip tooltip-left" data-tip="{% translate "Create New Issue for this Epic" %}">
                <div tabindex="0" role="button" class="btn btn-xs btn-square btn-success">
                  <i class="fa fa-plus text-xs"></i>
                </div>
                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-10 w-40 p-2 shadow-md mb-1">
                  <li>
                    <button type="button"
                            hx-get="{% url 'milestones:milestone_new_issue' workspace.slug project.key milestone.key 'story' %}?modal=1{% if group.epic_key %}&parent={{ group.epic_key }}{% endif %}"
                            hx-target="#new-issue-modal-content"
                            hx-swap="innerHTML"
                            @click="newIssueModalTitle = '{% translate "New Story" %}'; showNewIssueModal = true; document.activeElement.blur()">
                      <i class="fa fa-book text-info"></i>
                      {% translate "Story" %}
                    </button>
                  </li>
                  <li>
                    <button type="button"
                            hx-get="{% url 'milestones:milestone_new_issue' workspace.slug project.key milestone.key 'bug' %}?modal=1{% if group.epic_key %}&parent={{ group.epic_key }}{% endif %}"
                            hx-target="#new-issue-modal-content"
                            hx-swap="innerHTML"
                            @click="newIssueModalTitle = '{% translate "New Bug" %}'; showNewIssueModal = true; document.activeElement.blur()">
                      <i class="fa fa-bug text-error"></i>
                      {% translate "Bug" %}
                    </button>
                  </li>
                  <li>
                    <button type="button"
                            hx-get="{% url 'milestones:milestone_new_issue' workspace.slug project.key milestone.key 'chore' %}?modal=1{% if group.epic_key %}&parent={{ group.epic_key }}{% endif %}"
                            hx-target="#new-issue-modal-content"
                            hx-swap="innerHTML"
                            @click="newIssueModalTitle = '{% translate "New Chore" %}'; showNewIssueModal = true; document.activeElement.blur()">
                      <i class="fa fa-wrench text-warning"></i>
                      {% translate "Chore" %}
                    </button>
                  </li>
                </ul>
              </div>
            </div>
            {% elif not sprint and group_by == "epic" %}
            {# Add issue button for epic groups outside milestone context - navigates to page #}
            <div class="flex justify-end px-4 py-2 border-t border-base-200">
              <div class="dropdown dropdown-end dropdown-top tooltip tooltip-left" data-tip="{% translate "Create New Issue for this Epic" %}">
                <div tabindex="0" role="button" class="btn btn-xs btn-square btn-success">
                  <i class="fa fa-plus text-xs"></i>
                </div>
                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-10 w-40 p-2 shadow-md mb-1">
                  <li>
                    <a href="{% url 'issues:issue_create_typed' workspace.slug project.key 'story' %}?project={{ project.key }}&next={{ project.get_absolute_url|urlencode }}{% if group.epic_key %}&parent={{ group.epic_key }}{% endif %}"
                       hx-get="{% url 'issues:issue_create_typed' workspace.slug project.key 'story' %}?project={{ project.key }}&next={{ project.get_absolute_url|urlencode }}{% if group.epic_key %}&parent={{ group.epic_key }}{% endif %}"
                       hx-target="#page-content"
                       hx-push-url="true">
                      <i class="fa fa-book text-info"></i>
                      {% translate "Story" %}
                    </a>
                  </li>
                  <li>
                    <a href="{% url 'issues:issue_create_typed' workspace.slug project.key 'bug' %}?project={{ project.key }}&next={{ project.get_absolute_url|urlencode }}{% if group.epic_key %}&parent={{ group.epic_key }}{% endif %}"
                       hx-get="{% url 'issues:issue_create_typed' workspace.slug project.key 'bug' %}?project={{ project.key }}&next={{ project.get_absolute_url|urlencode }}{% if group.epic_key %}&parent={{ group.epic_key }}{% endif %}"
                       hx-target="#page-content"
                       hx-push-url="true">
                      <i class="fa fa-bug text-error"></i>
                      {% translate "Bug" %}
                    </a>
                  </li>
                  <li>
                    <a href="{% url 'issues:issue_create_typed' workspace.slug project.key 'chore' %}?project={{ project.key }}&next={{ project.get_absolute_url|urlencode }}{% if group.epic_key %}&parent={{ group.epic_key }}{% endif %}"
                       hx-get="{% url 'issues:issue_create_typed' workspace.slug project.key 'chore' %}?project={{ project.key }}&next={{ project.get_absolute_url|urlencode }}{% if group.epic_key %}&parent={{ group.epic_key }}{% endif %}"
                       hx-target="#page-content"
                       hx-push-url="true">
                      <i class="fa fa-wrench text-warning"></i>
                      {% translate "Chore" %}
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% elif issues %}
      {# Flat table view #}
      <div class="table-responsive">
        <table class="table mt-table">
          <thead>
            <tr>
              <th class="w-10">
                <input type="checkbox"
                       class="checkbox checkbox-sm"
                       id="embed-select-all"
                       @change="
                         document.querySelectorAll('#issues-embed [name=issues]').forEach(cb => cb.checked = $event.target.checked);
                         selectedCount = $event.target.checked ? {{ issues|length }} : 0;
                       ">
              </th>
              <th>{% translate "Key" %}</th>
              <th>{% translate "Type" %}</th>
              <th>{% translate "Title" %}</th>
              {% if sprint %}<th>{% translate "Project" %}</th>{% endif %}
              <th>{% translate "Status" %}</th>
              <th>{% translate "Priority" %}</th>
              <th>{% translate "Assignee" %}</th>
              <th>{% translate "Points" %}</th>
              <th class="w-10"></th>
            </tr>
          </thead>
          <tbody>
            {% for issue in issues %}
            {% include "issues/includes/issue_row_embed.html" with issue=issue total_issues=issues|length %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% include "issues/includes/embed_paginator_htmx.html" %}
      {% else %}
      <div class="text-center py-8">
        {% if search_query %}
        <p class="text-gray-500 mb-4">{% translate "No issues found matching your search." %}</p>
        {% else %}
        <p class="text-gray-500 mb-4">{% translate "No issues yet." %}</p>
        {% endif %}
      </div>
      {% endif %}
      {% endpartialdef list-content %}
    </div>
    {% include "issues/includes/embed_bulk_delete_modal.html" %}
    {% include "issues/includes/embed_bulk_assignee_modal.html" %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"edit-modal-content" %}{% include "issues/includes/issue_edit_modal.html" %}{% endwith %}
    {% include "issues/includes/issue_action_modal.html" %}
    {% include "includes/delete_confirm_modal.html" with delete_modal_id=embed_modal_prefix|add:"delete-modal-content" %}
    {% if sprint %}
    {% include "issues/includes/embed_bulk_remove_from_sprint_modal.html" %}
    {% include "sprints/includes/add_issues_modal.html" %}
    {% elif epic %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"new-issue-modal-content" %}{% include "issues/includes/new_issue_modal.html" %}{% endwith %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"add-to-sprint-modal-content" %}{% include "issues/includes/add_to_sprint_modal.html" %}{% endwith %}
    {% include "issues/includes/embed_bulk_add_to_sprint_modal.html" %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"move-modal-content" %}{% include "issues/includes/issue_move_modal.html" %}{% endwith %}
    {% elif milestone %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"new-epic-modal-content" %}{% include "issues/includes/new_epic_modal.html" %}{% endwith %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"new-issue-modal-content" %}{% include "issues/includes/new_issue_modal.html" %}{% endwith %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"add-to-sprint-modal-content" %}{% include "issues/includes/add_to_sprint_modal.html" %}{% endwith %}
    {% include "issues/includes/embed_bulk_add_to_sprint_modal.html" %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"move-modal-content" %}{% include "issues/includes/issue_move_modal.html" %}{% endwith %}
    {% elif project_orphan %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"new-milestone-modal-content" %}{% include "projects/includes/new_milestone_modal.html" %}{% endwith %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"new-epic-modal-content" %}{% include "projects/includes/new_epic_modal.html" %}{% endwith %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"new-issue-modal-content" %}{% include "projects/includes/new_issue_modal.html" %}{% endwith %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"add-to-sprint-modal-content" %}{% include "issues/includes/add_to_sprint_modal.html" %}{% endwith %}
    {% include "issues/includes/embed_bulk_add_to_sprint_modal.html" %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"move-modal-content" %}{% include "issues/includes/issue_move_modal.html" %}{% endwith %}
    {% else %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"add-to-sprint-modal-content" %}{% include "issues/includes/add_to_sprint_modal.html" %}{% endwith %}
    {% include "issues/includes/embed_bulk_add_to_sprint_modal.html" %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"move-modal-content" %}{% include "issues/includes/issue_move_modal.html" %}{% endwith %}
    {% endif %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"convert-modal-content" %}{% include "issues/includes/issue_convert_modal.html" %}{% endwith %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"promote-modal-content" %}{% include "issues/includes/issue_promote_modal.html" %}{% endwith %}
    {% with embed_modal_content_id=embed_modal_prefix|add:"quick-view-modal-content" %}{% include "includes/quick_view_modal.html" %}{% endwith %}
    <div class="hidden"
         hx-get="{{ embed_url }}"
         hx-vals='{"status": "{{ status_filter|default:"" }}", "type": "{{ type_filter|default:"" }}", "priority": "{{ priority_filter|default:"" }}", "assignee": "{{ assignee_filter|default:"" }}", "sprint": "{{ sprint_filter|default:"" }}", "group_by": "{{ group_by|default:"" }}", "sort_by": "{{ sort_by|default:"" }}", "search": "{{ search_query|default:"" }}"}'
         hx-target="#issues-embed"
         hx-swap="innerHTML"
         hx-trigger="issueChanged from:body">
    </div>
    {% include "includes/filters_modal.html" %}
  </section>
  <div id="messages" class="toast toast-end toast-bottom z-50" hx-swap-oob="true">
    {% include "includes/messages.html" %}
  </div>
  {% endpartialdef embed-content %}
</div>
